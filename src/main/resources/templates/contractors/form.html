<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Novo Terceirizado ‚Ä¢ Organizatec</title>
    <link rel="stylesheet" th:href="@{/styles.css}"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root{ --bg:#0b0b10;--panel:#12121a;--card:#0f1117;--text:#e9eef5;--muted:#9aa4b2;
               --primary:#3b82f6;--accent:#22d3ee;--border:#1f2530;--danger:#ef4444;--ok:#10b981 }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;color:var(--text);
             background:radial-gradient(1200px 800px at 80% -10%,#12203355,transparent),var(--bg);
             font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
        a{color:inherit;text-decoration:none}
        .app{min-height:100svh;display:grid;grid-template-rows:auto 1fr}
        header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:rgba(11,11,16,.7);border-bottom:1px solid var(--border)}
        .nav{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:16px 20px}
        .brand{display:flex;align-items:center;gap:12px;font-weight:700}
        .badge{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:0 6px 30px #3b82f633}
        .nav-links{display:flex;gap:14px}
        .nav-links a{padding:8px 12px;border-radius:10px;border:1px solid transparent;transition:.2s}
        .nav-links a:hover{background:#0c1220;border-color:var(--border)}

        main{max-width:1200px;margin:0 auto;padding:28px 20px 40px;display:grid;gap:16px}
        .title{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
        .title h1{margin:0;font-size:clamp(20px,2.2vw,28px)}
        .actions{display:flex;gap:10px}
        .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0d1220;color:var(--text);cursor:pointer}
        .btn.primary{background:linear-gradient(135deg,var(--primary),var(--accent));border:none;color:#0b0b10;font-weight:700}
        .btn.ghost{background:#0e1220}

        .panel{background:linear-gradient(180deg,#0f1422 0%,#0d0f16 100%);border:1px solid var(--border);border-radius:16px;padding:20px;display:grid;gap:18px}
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
        .field{display:flex;flex-direction:column;gap:6px}
        .field label{font-size:13px;color:var(--muted)}
        .input,.select,textarea{
          width:100%;padding:12px;border-radius:10px;background:#0e1220;color:var(--text);border:1px solid var(--border)
        }
        .hint{font-size:12px;color:var(--muted)}
        .error-msg{font-size:12px;color:#fecaca}
        .divider{height:1px;background:var(--border);margin:4px 0}
        .invalid{border-color:#f87171 !important; box-shadow:0 0 0 3px rgba(248,113,113,.2)}
        @media (max-width:900px){.grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="nav">
            <div class="brand">
                <div class="badge">üßë‚Äçüîß</div>
                <span>Organizatec ¬∑ Novo Terceirizado</span>
            </div>
            <nav class="nav-links">
                <a th:href="@{/}">In√≠cio</a>
                <a th:href="@{/employees}">Funcion√°rios</a>
                <a th:href="@{/contractors}">Terceirizados</a>
                <a th:href="@{/reports/daily}">Relat√≥rio di√°rio</a>
                <a th:href="@{/logout}">Sair</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="title">
            <h1>Cadastrar terceirizado</h1>
            <div class="actions">
                <a class="btn ghost" th:href="@{/contractors}">Cancelar</a>
                <button class="btn primary" form="contractorForm" type="submit">Salvar</button>
            </div>
        </div>

        <section class="panel">
            <!-- Espera: contractor, employees, departments -->
            <form id="contractorForm" th:action="@{/contractors}" th:object="${contractor}" method="post" class="grid" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="field" style="grid-column:span 6;">
                    <label for="name">Nome completo</label>
                    <input id="name" class="input" th:field="*{name}" required
                           th:classappend="${#fields.hasErrors('name')} ? ' invalid'"/>
                    <div class="error-msg" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">erro</div>
                </div>

                <div class="field" style="grid-column:span 3;">
                    <label for="cpf">CPF</label>
                    <input id="cpf" class="input" th:field="*{cpf}" required maxlength="14" placeholder="000.000.000-00"
                           th:classappend="${#fields.hasErrors('cpf')} ? ' invalid'"/>
                    <div class="error-msg" th:if="${#fields.hasErrors('cpf')}" th:errors="*{cpf}">erro</div>
                </div>

                <div class="field" style="grid-column:span 3;">
                    <label for="vendorCompany">Empresa prestadora</label>
                    <input id="vendorCompany" class="input" th:field="*{vendorCompany}" required maxlength="120"
                           th:classappend="${#fields.hasErrors('vendorCompany')} ? ' invalid'"/>
                    <div class="error-msg" th:if="${#fields.hasErrors('vendorCompany')}" th:errors="*{vendorCompany}">erro</div>
                </div>

                <div class="field" style="grid-column:span 4;">
                    <label for="roleTitle">Fun√ß√£o</label>
                    <input id="roleTitle" class="input" th:field="*{roleTitle}" required maxlength="100"
                           th:classappend="${#fields.hasErrors('roleTitle')} ? ' invalid'"/>
                    <div class="error-msg" th:if="${#fields.hasErrors('roleTitle')}" th:errors="*{roleTitle}">erro</div>
                </div>

                <div class="field" style="grid-column:span 4;">
                    <label for="contractStart">In√≠cio do contrato</label>
                    <input id="contractStart" class="input" type="date" th:field="*{contractStart}" required
                           th:classappend="${#fields.hasErrors('contractStart')} ? ' invalid'"/>
                    <div class="error-msg" th:if="${#fields.hasErrors('contractStart')}" th:errors="*{contractStart}">erro</div>
                </div>

                <div class="field">
                    <label for="contractEnd">T√©rmino do contrato</label>
                    <input id="contractEnd" class="input" type="date"
                           th:field="*{contractEnd}"
                           th:attr="min=${#temporals.format(#temporals.createNow(),'yyyy-MM-dd')}"
                           placeholder="Opcional"/>
                </div>

                <div class="field" style="grid-column:span 6;">
                    <label for="internalResponsible">Respons√°vel interno</label>
                    <select id="internalResponsible" class="select" th:field="*{internalResponsible.id}">
                        <option value="" th:selected="${contractor.internalResponsible == null}">Selecione‚Ä¶ (opcional)</option>
                        <option th:each="e : ${employees}" th:value="${e.id}" th:text="${e.name}"></option>
                    </select>
                </div>

                <div class="field" style="grid-column:span 6;">
                    <label for="departments">Departamentos (m√∫ltiplos)</label>
                    <!-- Importante: usamos name='departmentIds' para o controller ler @RequestParam List<Long> -->
                    <select id="departments" class="select" name="departmentIds" multiple size="5">
                        <option th:each="d : ${departments}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                    <div class="hint">Segure Ctrl/Cmd para selecionar m√∫ltiplos.</div>
                </div>

                <div class="field" style="grid-column:span 4;">
                    <label for="badgeCode">Crach√° (opcional)</label>
                    <input id="badgeCode" class="input" th:field="*{badgeCode}" maxlength="20" placeholder="Se vazio, o sistema gera"/>
                </div>

                <div class="divider" style="grid-column:1/-1;"></div>

                <div class="actions" style="grid-column:1/-1;display:flex;justify-content:flex-end;gap:10px;">
                    <a class="btn ghost" th:href="@{/contractors}">Cancelar</a>
                    <button class="btn primary" type="submit">Salvar</button>
                </div>
            </form>
        </section>
    </main>
</div>

<script>
    // m√°scara simples de CPF 000.000.000-00
    (function(){
      const cpf = document.getElementById('cpf');
      if(!cpf) return;
      cpf.addEventListener('input', function(){
        let v = cpf.value.replace(/\D/g,'').slice(0,11);
        let m = '';
        if(v.length>0) m = v.slice(0,3);
        if(v.length>=4) m += '.'+v.slice(3,6);
        if(v.length>=7) m += '.'+v.slice(6,9);
        if(v.length>=10) m += '-'+v.slice(9,11);
        cpf.value = m;
      });
    })();

    // destaque de campos inv√°lidos + valida√ß√£o de per√≠odo
    (function(){
      const form = document.getElementById('contractorForm');
      if(!form) return;

      form.addEventListener('input', e => e.target.classList.remove('invalid'));
      form.addEventListener('change', e => e.target.classList.remove('invalid'));

      form.addEventListener('submit', function(e){
        // limpa marcas antigas
        form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));

        // valida HTML5
        if(!form.checkValidity()){
          e.preventDefault();
          const invalids = Array.from(form.querySelectorAll('input:invalid, select:invalid, textarea:invalid'));
          invalids.forEach(el => el.classList.add('invalid'));
          const items = invalids.map(el => {
            const label = form.querySelector(`label[for="${el.id}"]`);
            return '‚Ä¢ ' + (label ? label.textContent.trim() : (el.name || 'Campo'));
          });
          Swal.fire({icon:'warning', title:'Campos obrigat√≥rios', html: items.join('<br>'), confirmButtonText:'Entendi'});
          if(invalids.length) invalids[0].focus();
          return;
        }

        // valida datas coerentes
        const start = document.getElementById('contractStart').value;
        const end   = document.getElementById('contractEnd').value;
        if(end && start && end < start){
          e.preventDefault();
          const startEl = document.getElementById('contractStart');
          const endEl   = document.getElementById('contractEnd');
          startEl.classList.add('invalid'); endEl.classList.add('invalid');
          Swal.fire({icon:'warning', title:'Per√≠odo inv√°lido', text:'A data de t√©rmino n√£o pode ser anterior ao in√≠cio do contrato.', confirmButtonText:'Entendi'});
          endEl.focus();
        }
      });
    })();
</script>

<script th:if="${errorMessage}">
    Swal.fire({ icon:'warning', title:'N√£o foi poss√≠vel salvar', text:'[[${errorMessage}]]', confirmButtonText:'Entendi' });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    (function () {
      const form = document.getElementById('contractForm');   // id do <form>
      if (!form) return;

      form.addEventListener('submit', function (e) {
        const endVal = (document.getElementById('contractEnd')?.value || '').trim();
        if (!endVal) return; // t√©rmino √© opcional

        // normaliza datas para comparar apenas Y-M-D
        const today = new Date();
        today.setHours(0,0,0,0);
        const endDate = new Date(endVal + 'T00:00:00');

        if (endDate < today) {
          e.preventDefault();
          Swal.fire({
            icon: 'warning',
            title: 'Data inv√°lida',
            text: 'O t√©rmino do contrato n√£o pode ser anterior a hoje.',
            confirmButtonText: 'Entendi'
          });
        }
      });
    })();
</script>
</body>
</html>